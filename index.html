function generateHTMLundPushToGitHub() {
  const apiKey = PropertiesService.getScriptProperties().getProperty("GOOGLE_MAPS_API_KEY");
  const githubToken = PropertiesService.getScriptProperties().getProperty("GITHUB_TOKEN");
  const repo = "ncp24/apotheken-map";
  const branch = "main";

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Not_Apotheken");
  const data = sheet.getDataRange().getValues();
  const header = data[0];

  const dateIndex = header.indexOf("date");
  const timeIndex = header.indexOf("Time");
  const nameIndex = header.indexOf("Name");
  const addressIndex = header.indexOf("Address");
  const phoneIndex = header.indexOf("Phone number");
  const latIndex = header.indexOf("Latitude");
  const lonIndex = header.indexOf("Longitude");

  let markersJs = "";

  for (let i = 1; i < data.length; i++) {
    const lat = data[i][latIndex];
    const lon = data[i][lonIndex];
    if (!lat || !lon) continue;

    const name = data[i][nameIndex] || "Unnamed";
    const address = data[i][addressIndex] || "No address";
    const phone = data[i][phoneIndex] || "No phone";
    const date = data[i][dateIndex] || "No date";
    const time = data[i][timeIndex] || "No time";

    markersJs += `
      new google.maps.Marker({
        position: { lat: ${lat}, lng: ${lon} },
        map: map,
        title: "${name}"
      }).addListener("click", () => {
        infoWindow.setContent(\`
          <div>
            <h3>? ${name}</h3>
            <p>? Date: ${date}</p>
            <p>? Time: ${time}</p>
            <p>? Address: ${address}</p>
            <p>? Phone: ${phone}</p>
            <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" target="_blank">
              <button style="background-color:#007bff;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;">? Navigate</button>
            </a>
          </div>\`);
        infoWindow.open(map, this);
      });
    `;
  }

  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8" />
      <title>Pharmacies Map</title>
      <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { height: 100%; width: 100%; }
      </style>
    </head>
    <body>
      <div id="map"></div>
      <script src="https://maps.googleapis.com/maps/api/js?key=${apiKey}"></script>
      <script>
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 9,
          center: { lat: 35.2, lng: 33.4 },
        });
        const infoWindow = new google.maps.InfoWindow();
        ${markersJs}
      </script>
    </body>
    </html>
  `;

  pushToGitHub("index.html", htmlContent, githubToken, repo, branch);

  const configContent = `const CONFIG = {\n  apiKey: "${apiKey}"\n};\n`;
  pushToGitHub("config.js", configContent, githubToken, repo, branch);
}
